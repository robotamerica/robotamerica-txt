<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>robotamerica · md mirror</title>
  <style>
    :root{
      --bg:#0b0f0c;
      --ink:#e8efe9;
      --muted:#a7b3aa;
      --line:#1a241d;
      --link:#a8ff7a;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", "Roboto Mono", monospace;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--mono);
      font-size:14px;
      line-height:1.55;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{
      display:grid;
      grid-template-columns: 320px 1fr;
      height:100vh;
    }

    /* left: plain index */
    nav{
      border-right:1px solid var(--line);
      padding:14px;
      overflow:auto;
    }
    nav .hdr{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:700;
      letter-spacing:.02em;
    }
    nav .sub{
      margin:0 0 12px 0;
      color:var(--muted);
      font-size:12px;
    }
    .group{
      margin:14px 0 0 0;
    }
    .group-title{
      margin:0 0 6px 0;
      color:var(--muted);
      font-size:12px;
      text-transform:lowercase;
      letter-spacing:.04em;
    }
    ul{
      list-style:none;
      padding:0;
      margin:0;
    }
    li{
      padding:4px 0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    li::before{ content:"* "; color:var(--muted); }
    .small{
      color:var(--muted);
      font-size:12px;
    }

    /* right: markdown viewer, still plain */
    main{
      padding:14px;
      overflow:auto;
    }
    .topline{
      color:var(--muted);
      font-size:12px;
      padding-bottom:10px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* “fancy markdown” but restrained */
    .md{
      max-width: 900px;
    }
    .md h1,.md h2,.md h3{
      font-size:14px;
      font-weight:700;
      margin:16px 0 8px;
    }
    .md h1{ margin-top:0; }
    .md p{ margin:0 0 10px; }
    .md ul,.md ol{
      margin:0 0 10px 0;
      padding-left:16px;
    }
    .md ul{ list-style:disc; }
    .md ol{ list-style:decimal; }
    .md blockquote{
      margin:0 0 10px;
      padding-left:12px;
      border-left:2px solid var(--line);
      color:var(--muted);
    }
    .md hr{
      border:0;
      border-top:1px solid var(--line);
      margin:14px 0;
    }
    .md code{
      font-family:var(--mono);
      font-size:0.95em;
    }
    .md pre{
      border:1px solid var(--line);
      padding:10px;
      overflow:auto;
      margin:0 0 12px;
      background:transparent;
    }
    .md pre code{
      display:block;
      white-space:pre;
    }

    @media (max-width: 860px){
      .wrap{ grid-template-columns: 1fr; }
      nav{ height: 42vh; border-right:none; border-bottom:1px solid var(--line); }
    }
  </style>

  <!-- markdown renderer (small + reliable) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <nav>
      <div class="hdr">robotamerica · md mirror</div>
      <div class="sub">a plain index + a markdown viewer</div>

      <div class="group">
        <div class="group-title">entry</div>
        <ul id="entry"></ul>
      </div>

      <div class="group">
        <div class="group-title">pages</div>
        <ul id="pages"><li class="small">loading…</li></ul>
      </div>

      <div class="group">
        <div class="group-title">posts</div>
        <ul id="posts"><li class="small">loading…</li></ul>
      </div>

      <div class="group">
        <div class="group-title">raw</div>
        <ul>
          <li><a href="./index.md">index.md</a></li>
          <li><a href="./site.md">site.md</a></li>
        </ul>
      </div>
    </nav>

    <main>
      <div class="topline" id="where">loading…</div>
      <div class="md" id="view">loading…</div>
    </main>
  </div>

<script>
  // minimal config: no “extras”, just good markdown
  marked.setOptions({
    gfm: true,
    breaks: false,
    headerIds: false,
    mangle: false
  });

  const ENTRY = [
    { label: "site (whole site)", file: "site.md" },
    { label: "index (directory)", file: "index.md" },
  ];

  function esc(s){ return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function renderList(el, items, prefix=""){
    el.innerHTML = "";
    for(const it of items){
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.textContent = it.label;
      a.href = `#${prefix}${it.file}`;
      a.title = `${prefix}${it.file}`;
      li.appendChild(a);
      el.appendChild(li);
    }
  }

  async function fetchText(rel){
    const res = await fetch(`./${rel}`, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  }

  function currentTarget(){
    const h = (location.hash||"").replace(/^#/, "");
    return h || "site.md";
  }

  async function show(rel){
    const where = document.getElementById("where");
    const view = document.getElementById("view");
    where.textContent = `file: ${rel}`;

    try{
      const md = await fetchText(rel);

      // Render markdown to HTML (links become live automatically)
      const html = marked.parse(md);

      // Keep links within the mirror “live”:
      // - if a link points to ./posts/foo.md or ./pages/bar.md, intercept → load in viewer
      // - otherwise, open normally (same tab)
      view.innerHTML = html;

      view.querySelectorAll("a[href]").forEach(a => {
        const href = a.getAttribute("href") || "";
        // normalize common cases
        const h = href.replace(/^\.\/+/, "");
        if (h.endsWith(".md") && (h.startsWith("posts/") || h.startsWith("pages/") || h === "site.md" || h === "index.md")) {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            location.hash = `#${h}`;
          });
        }
      });

    }catch(e){
      view.innerHTML = `<pre>${esc(
`could not load: ${rel}

check:
- file exists under /docs
- github pages is set to main + /docs

error: ${e.message}`
      )}</pre>`;
    }
  }

  async function loadManifest(){
    // Parse docs/index.md for links like: [foo.md](posts/foo.md) — https://...
    const txt = await fetchText("index.md");
    const re = /\[([^\]]+)\]\((pages|posts)\/([^)]+)\)/g;

    const pages = [];
    const posts = [];
    let m;
    while((m = re.exec(txt)) !== null){
      const filename = m[1];          // foo.md
      const kind = m[2];              // pages|posts
      const rel = `${kind}/${m[3]}`;  // pages/foo.md
      const label = filename.replace(/\.md$/,"");
      (kind === "pages" ? pages : posts).push({ label, file: rel });
    }

    pages.sort((a,b)=>a.label.localeCompare(b.label));
    posts.sort((a,b)=>a.label.localeCompare(b.label));
    return { pages, posts };
  }

  async function main(){
    renderList(document.getElementById("entry"), ENTRY);

    try{
      const { pages, posts } = await loadManifest();
      renderList(document.getElementById("pages"), pages);
      renderList(document.getElementById("posts"), posts);
    }catch(_){
      document.getElementById("pages").innerHTML = `<li class="small">manifest missing</li>`;
      document.getElementById("posts").innerHTML = `<li class="small">manifest missing</li>`;
    }

    window.addEventListener("hashchange", () => show(currentTarget()));
    await show(currentTarget());
  }

  main();
</script>
</body>
</html>
